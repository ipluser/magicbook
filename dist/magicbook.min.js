!function(n,r){function a(n,r){return y.call(n)===r}function t(n){return a(n,"[object Function]")}function o(n){return a(n,"[object String]")}function e(n){return a(n,"[object Array]")}function i(n){return"undefined"==typeof n}function c(n){return null===n||i(n)?[]:e(n)&&n||[n]}function u(n,r,a){return n&&r&&n[r]||a}function l(n,r){return{}.hasOwnProperty.call(n,r)}function s(n,a){n&&r.get(n).success(function(n){a&&t(a.success)&&a.success(n)}).fail(function(n){a&&t(a.fail)&&a.fail(n)}).always(function(){a&&t(a["finally"])&&a["finally"]()})}function f(n,r,a,o){var i,c,l,s=!1;if(!e(n))return s;for(i=0,c=n.length;c>i;i++)l=u(n[i],r),t(l)&&(s=!0,l.apply(a,o));return s}function g(n,a){var t=r(n);t&&!t.hasClass(a)&&t.addClass(a)}function v(n,r){g(n,h+r)}function d(n,r){n.after(r),n.remove(),r.append(n)}var p={container:"",navigator:"",content:"",navigatorUrl:"navigator.md",homeUrl:"README.md",baseUrl:"",urlArgs:"",debug:!1,navigatorCallbackQueue:[],routeCallbackQueue:[]},h="magicbook-",m=n.location,b=Object.prototype,y=b.toString,k=n.Magicbook=function C(a){function t(){var n,a,t,o=u.container,e=u.navigator,c=u.content,l=r('<div class="magicbook-navigator-wrap"></div>'),s=r('<div class="magicbook-content-wrap"></div>');e||c?(e&&(a=r(e),a.length&&(v(a,"navigator"),d(a,l))),c&&(t=r(c),t.length&&(v(t,"content"),d(t,s)))):(n=r(o),n.length||(n=r('<div class="magicbook-container"></div>'),r("body").prepend(n)),v(n,"container"),a=r('<div class="magicbook-navigator"></div>'),t=r('<div class="magicbook-content"></div>'),l.append(a),s.append(t),n.append(l).append(s)),i.$container=n,i.$navigatorWrap=l,i.$contentWrap=s,i.$navigator=a,i.$content=t}function o(a){var t,o,e;for(t=0,o=a.length;o>t;t++)e=r(a[t]),e.attr("src",i.normalizeImageUrl(n.location.hash||i.config.homeUrl,e.attr("src")))}function e(){var n=i.normalizeUrl(u.navigatorUrl),r=u.navigatorCallbackQueue;n&&s(n,{success:function(n){var a=i.parser(n);i.$navigator&&i.$navigator.empty().append(i.parser(n)),f(r,"success",i,[{origin:n,result:a}])},fail:function(n){f(r,"fail",i,[n])||i.$navigator&&i.$navigator.empty().append('<div class="magicbook-navigator__error magicbook-error">navigator not found</div>')},"finally":function(){f(r,"finally",i)}})}if(!(this instanceof C))return new C(a);var i=this,u=i.config=r.extend({},p,a);t(),u.navigatorCallbackQueue=c(u.navigatorCallbackQueue),u.routeCallbackQueue=c(u.routeCallbackQueue),u.navigatorCallbackQueue.unshift({success:function(){o(i.$navigatorWrap.find("img"))}}),u.routeCallbackQueue.unshift({success:function(){o(i.$contentWrap.find("img"))}}),i.handlers={},i.handlersCount=0,i.handler("drawNavigator",e,{priority:1}),i.handler("drawContent",function(){i.route()},{priority:1}),n.onhashchange=function(){i.route(m.hash)}},$=k.prototype;$.parser=function(n){return n},$.route=function(n,r){var a=this,t=o(n)&&n||m.hash||a.config.homeUrl;t=a.normalizeUrl(t),a.render(t,r)},$.render=function(n,r){var a=this,t=a.config.routeCallbackQueue,o=c(r);n&&s(n,{success:function(n){var r=a.parser(n);a.$content&&a.$content.empty().append(r),f(t,"success",a,[{origin:n,result:r}]),f(o,"success",a,[{origin:n,result:r}])},fail:function(n){f(t,"fail",a,[n])||f(o,"fail",a,[n])||a.$content&&a.$content.empty().append('<div class="magicbook-content__error magicbook-error">content not found</div>')},"finally":function(){f(t,"finally",a),f(o,"finally",a)}})},$.normalizeUrl=function(n){if(!n)return n;var r=this,a=r.config,t=a.urlArgs,e=a.baseUrl+n.replace(/^#/,"");return t&&o(t)&&(e+=(-1===e.indexOf("?")?"?":"&")+t),e},$.normalizeImageUrl=function(n,r){var a=this,t=n||"";return!n&&!r||!o(n)||r&&!o(r)?r||"":-1!==r.search(/\:\/\//)?r:(t=t.replace(/\#/,"").replace(/\/$/,""),t=t+(n&&"/../"||"")+(r||""),a.normalizeUrl(t))},$.handler=function(n,a,t){var e=this,i=e.handlers;if(n&&o(n)&&!a&&!t)return i[n];var c=i[n],u={order:c&&c.order||e.handlersCount++,name:n,action:a,options:r.extend({priority:2},t)};i[n]=u},$.show=function(){var n,r,a=this,o=a.handlers,e=[];for(var i in o){if(!l(o,i))return;var c=o[i],u=c.options.priority;for(n=0,r=e.length;r>n;n++){var s=e[n],f=s.options.priority;if(f>u||u===f&&c.order<s.order)break}e.splice(n,0,c)}for(n=0,r=e.length;r>n;n++){var g=e[n].action;t(g)&&g.call(this)}}}(window,jQuery);