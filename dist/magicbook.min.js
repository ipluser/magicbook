!function(n,r){function a(n,r){return p.call(n)===r}function t(n){return a(n,"[object Function]")}function o(n){return a(n,"[object String]")}function i(n){return a(n,"[object Array]")}function e(n){return"undefined"==typeof n}function c(n){return null===n||e(n)?[]:i(n)&&n||[n]}function u(n,r,a){return n&&r&&n[r]||a}function l(n,r){return{}.hasOwnProperty.call(n,r)}function s(n,a){n&&r.get(n).success(function(n){a&&t(a.success)&&a.success(n)}).fail(function(n){a&&t(a.fail)&&a.fail(n)}).always(function(){a&&t(a["finally"])&&a["finally"]()})}function f(n,r,a,o){var e,c,l,s=!1;if(!i(n))return s;for(e=0,c=n.length;c>e;e++)l=u(n[e],r),t(l)&&(s=!0,l.apply(a,o));return s}var g={container:"",navigator:"",content:"",navigatorUrl:"navigator.md",homeUrl:"README.md",baseUrl:"",urlArgs:"",debug:!1,navigatorCallbackQueue:[],routeCallbackQueue:[]},v=n.location,d=Object.prototype,p=d.toString,h=n.Magicbook=function m(a){function t(a){var t,o,e;for(t=0,o=a.length;o>t;t++)e=r(a[t]),e.attr("src",i.normalizeImageUrl(n.location.hash||i.config.homeUrl,e.attr("src")))}function o(){var n=i.normalizeUrl(e.navigatorUrl),r=e.navigatorCallbackQueue;n&&s(n,{success:function(n){var a=i.parser(n);i.$navigator.empty().append(i.parser(n)),f(r,"success",i,[{origin:n,result:a}])},fail:function(n){f(r,"fail",i,[n])||i.$navigator.empty().append('<div class="magicbook-navigator__error magicbook-error">navigator not found</div>')},"finally":function(){f(r,"finally",i)}})}if(!(this instanceof m))return new m(a);var i=this,e=i.config=r.extend({},g,a),u=i.$container=e.container&&r(e.container)||r('<div class="magicbook-container"></div>'),l=i.$navigatorWrap=r('<div class="magicbook-navigator-wrap"></div>'),d=i.$navigator=e.navigator&&r(e.navigator)||r('<div class="magicbook-navigator"></div>'),p=i.$contentWrap=r('<div class="magicbook-content-wrap"></div>'),h=i.$content=e.content&&r(e.content)||r('<div class="magicbook-content"></div>');!e.navigator&&l.append(d),!e.content&&p.append(h),!e.container&&r("body").append(u),u.append(l).append(p),e.navigatorCallbackQueue=c(e.navigatorCallbackQueue),e.routeCallbackQueue=c(e.routeCallbackQueue),e.navigatorCallbackQueue.unshift({success:function(){t(i.$navigatorWrap.find("img"))}}),e.routeCallbackQueue.unshift({success:function(){t(i.$contentWrap.find("img"))}}),i.handlers={},i.handlersCount=0,i.handler("drawNavigator",o,{priority:1}),i.handler("drawContent",function(){i.route()},{priority:1}),n.onhashchange=function(){i.route(v.hash)}},b=h.prototype;b.parser=function(n){return n},b.route=function(n,r){var a=this,t=o(n)&&n||v.hash||a.config.homeUrl;t=a.normalizeUrl(t),a.render(t,r)},b.render=function(n,r){var a=this,t=a.config.routeCallbackQueue,o=c(r);n&&s(n,{success:function(n){var r=a.parser(n);a.$content.empty().append(r),f(t,"success",a,[{origin:n,result:r}]),f(o,"success",a,[{origin:n,result:r}])},fail:function(n){f(t,"fail",a,[n])||f(o,"fail",a,[n])||a.$content.empty().append('<div class="magicbook-content__error magicbook-error">content not found</div>')},"finally":function(){f(t,"finally",a),f(o,"finally",a)}})},b.normalizeUrl=function(n){if(!n)return n;var r=this,a=r.config,t=a.urlArgs,i=a.baseUrl+n.replace(/^#/,"");return t&&o(t)&&(i+=(-1===i.indexOf("?")?"?":"&")+t),i},b.normalizeImageUrl=function(n,r){var a=this,t=n||"";return!n&&!r||!o(n)||r&&!o(r)?r||"":-1!==r.search(/\:\/\//)?r:(t=t.replace(/\#/,"").replace(/\/$/,""),t=t+(n&&"/../"||"")+(r||""),a.normalizeUrl(t))},b.handler=function(n,a,t){var i=this,e=i.handlers;if(n&&o(n)&&!a&&!t)return e[n];var c=e[n],u={order:c&&c.order||i.handlersCount++,name:n,action:a,options:r.extend({priority:2},t)};e[n]=u},b.show=function(){var n,r,a=this,o=a.handlers,i=[];for(var e in o){if(!l(o,e))return;var c=o[e],u=c.options.priority;for(n=0,r=i.length;r>n;n++){var s=i[n],f=s.options.priority;if(f>u||u===f&&c.order<s.order)break}i.splice(n,0,c)}for(n=0,r=i.length;r>n;n++){var g=i[n].action;t(g)&&g.call(this)}}}(window,jQuery);